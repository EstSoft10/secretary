<header class="header" th:fragment="header">
    <div class="logo">
        <a th:href="@{/}">A:ssistant</a>
    </div>
    <div th:if="${#authentication != null or #authentication.authenticated}" class="side-menu-user-info">

        <form th:action="@{/logout}" method="post" class="logout-form">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="logout-btn">로그아웃</button>
        </form>
    </div>
    <div class="hamburger" id="hamburger" onclick="toggleMenu(true)">
        &#9776;
    </div>
    <nav id="sideMenu" class="side-menu">
        <div class="close-btn" onclick="toggleMenu(false)">✕</div>
        <div class="conversation-history" id="conversationHistory">
            <p th:text="${#authentication.principal.name + '님의 검색 기록'}" class="search-name"></p>
        </div>
    </nav>
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            window.toggleMenu = function (show) {
                const menu = document.getElementById("sideMenu");
                menu.style.display = show ? "block" : "none";
            };

            const userId = [[${#authentication.principal.member.id}]];
            fetch(`/api/conversation/${userId}`)
                .then(res => res.json())
                .then(data => {
                    const historyDiv = document.getElementById("conversationHistory");
                    if (!historyDiv) {
                        console.error("conversationHistory 요소가 없습니다!");
                        return;
                    }

                    const grouped = groupByDate(data);
                    Object.entries(grouped).forEach(([date, conversations], index) => {
                        const dateBlock = document.createElement("div");
                        dateBlock.className = "date-group";

                        const dateHeader = document.createElement("div");
                        dateHeader.className = "date-header";
                        dateHeader.innerHTML = `<span class="arrow">▶</span> ${date}`;

                        const convoList = document.createElement("ul");
                        convoList.className = "conversation-list hidden";
                        dateHeader.addEventListener("click", () => {
                            convoList.classList.toggle("hidden");
                            const arrow = dateHeader.querySelector(".arrow");
                            arrow.textContent = convoList.classList.contains("hidden") ? "▶" : "▼";
                        });

                        conversations.forEach(convo => {
                            const li = document.createElement("li");
                            li.innerHTML = `<a href="/searchResult?conversationId=${convo.id}" onclick="location.href=this.href">${convo.title}</a>`;
                            convoList.appendChild(li);
                        });

                        dateBlock.appendChild(dateHeader);
                        dateBlock.appendChild(convoList);
                        historyDiv.appendChild(dateBlock);
                    });

                });

            function groupByDate(conversations) {
                const grouped = {};
                conversations.forEach(c => {
                    const date = new Date(c.updatedAt).toISOString().split("T")[0];
                    if (!grouped[date]) grouped[date] = [];
                    grouped[date].push(c);
                });
                return grouped;
            }
        });


    </script>
</header>